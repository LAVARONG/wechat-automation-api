# 更新日志

## 2025-11-05

### 优化：会话列表智能激活机制

**修改文件：** `wechat_controller.py`

**功能描述：**
- 优化联系人查找策略，优先从左侧会话列表直接激活对话（更快）
- 添加会话选中状态检测，避免重复点击已选中的会话
- 保留搜索框作为降级方案，确保兼容性

**优化效果：**
- 对于最近聊天的联系人，响应速度显著提升
- 避免误操作：已选中的会话不会被重复点击（防止取消选择）
- 双重验证：点击/搜索后都会验证会话是否真正选中
- 降低搜索框使用频率，减少UI操作步骤

**技术实现：**
1. 新增 `_is_session_selected()` 方法：
   - 通过 `GetPattern(10010)` 获取 SelectionItemPattern
   - 检查 `IsSelected` 属性判断会话是否已选中

2. 新增 `_activate_from_session_list()` 方法：
   - 通过 `AutomationId="session_item_{联系人名}"` 和 `ClassName="mmui::ChatSessionCell"` 定位会话项
   - 检查会话选中状态，已选中则跳过点击
   - 点击后验证是否成功选中

3. 优化 `search_contact()` 方法：
   - **策略1（优先）**：尝试从会话列表直接激活
   - **策略2（降级）**：找不到时使用搜索框
   - 搜索后也验证会话选中状态

## 2025-10-31

### 优化：图片发送缓存机制

**修改文件：** `wechat_controller.py`

**功能描述：**
- 使用 MD5(url) 作为缓存文件名，避免相同URL的图片重复下载
- 发送图片前先检查缓存目录是否已存在该文件
- 如果文件存在则直接使用缓存，不存在才下载
- 缓存目录：系统临时目录下的 `wechat_image_cache` 文件夹

**优化效果：**
- 相同URL的图片只下载一次，显著提高重复发送速度
- 减少网络带宽消耗
- 改善用户体验

**技术实现：**
1. 导入 `hashlib` 模块用于计算MD5
2. 在 `__init__` 中创建缓存目录
3. 修改 `_download_image` 方法添加缓存检查逻辑
4. 移除 `send_picture` 方法中删除临时文件的逻辑


