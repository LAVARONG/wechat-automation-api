# 微信自动化 HTTP 服务使用说明

## 项目简介

这是一个基于 Flask 和 uiautomation 的微信自动化消息发送服务。通过 HTTP API 接收消息发送请求，使用队列管理消息，自动控制微信客户端发送消息。

## 功能特性

- ✅ HTTP API 接口，支持 RESTful 调用
- ✅ Token 身份验证，保证安全性
- ✅ 消息队列管理，按顺序发送
- ✅ 支持批量发送（一个内容发送给多个联系人）
- ✅ 支持发送文本消息
- ✅ 支持发送图片（通过 URL 下载后发送）
- ✅ 自动间隔控制（每条消息间隔 1 秒）
- ✅ 完善的日志记录
- ✅ 错误容错机制

## 环境要求

- Windows 10/11
- Python 3.7+
- 微信 PC 客户端（已登录）

## 安装步骤

### 1. 安装依赖

```powershell
pip install -r requirements.txt
```

### 2. 配置文件

首次使用需要复制配置文件示例：

```powershell
Copy-Item config.json.example config.json
```

然后编辑 `config.json` 文件，根据需要修改配置：

```json
{
    "token": "123123",           // API 访问令牌
    "host": "127.0.0.1",          // 服务监听地址
    "port": 8808,                 // 服务监听端口
    "message_interval": 1,        // 消息发送间隔（秒）
    "log_level": "INFO",          // 日志级别
    "log_file": "wechat_automation.log"  // 日志文件路径
}
```

## 启动服务

### 方法一：直接运行

```powershell
python app.py
```

### 方法二：后台运行（可选）

```powershell
# 使用 start 命令在新窗口中运行
start python app.py
```

启动成功后会显示：

```
========================================
微信自动化服务已启动
监听地址: http://127.0.0.1:8808
API 端点: POST http://127.0.0.1:8808/
状态查询: GET http://127.0.0.1:8808/status
健康检查: GET http://127.0.0.1:8808/health
========================================
```

## API 使用说明

### 1. 发送消息

**端点**: `POST http://127.0.0.1:8808/`

**请求头**:
```
Content-Type: application/json
```

#### 1.1 发送文本消息

**请求体**:
```json
{
    "token": "123123",
    "action": "sendtext",
    "to": ["线报转发", "LAVA"],
    "content": "你好，这是自动化测试消息"
}
```

**参数说明**:
- `token`: 身份验证令牌（必须与 config.json 中一致）
- `action`: 操作类型，"sendtext" 表示发送文本消息
- `to`: 接收者数组，可以包含多个联系人名称
- `content`: 文本消息内容

#### 1.2 发送图片消息

**请求体**:
```json
{
    "token": "123123",
    "action": "sendpic",
    "to": ["线报转发", "LAVA"],
    "content": "https://example.com/image.jpg"
}
```

**参数说明**:
- `token`: 身份验证令牌（必须与 config.json 中一致）
- `action`: 操作类型，"sendpic" 表示发送图片
- `to`: 接收者数组，可以包含多个联系人名称
- `content`: 图片的 URL 地址（支持 http/https）

**图片发送说明**:
- 系统会自动下载图片到临时文件
- 将图片放入剪贴板
- 在微信聊天窗口粘贴发送
- 发送完成后自动清理临时文件
- 支持常见图片格式：JPG、PNG、GIF、BMP 等

**成功响应** (200):
```json
{
    "success": true,
    "message": "消息已加入队列",
    "queued_count": 2,
    "queue_size": 2
}
```

**失败响应** (401):
```json
{
    "success": false,
    "error": "无效的 token"
}
```

### 2. 查询状态

**端点**: `GET http://127.0.0.1:8808/status`

**响应**:
```json
{
    "status": "running",
    "queue_size": 5
}
```

### 3. 健康检查

**端点**: `GET http://127.0.0.1:8808/health`

**响应**:
```json
{
    "status": "healthy"
}
```

## 使用示例

### PowerShell 示例

```powershell
# 发送文本消息
$body = @{
    token = "123123"
    action = "sendtext"
    to = @("线报转发")
    content = "这是一条测试消息"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://127.0.0.1:8808/" -Method Post -Body $body -ContentType "application/json"

# 发送图片消息
$body = @{
    token = "123123"
    action = "sendpic"
    to = @("线报转发")
    content = "https://example.com/image.jpg"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://127.0.0.1:8808/" -Method Post -Body $body -ContentType "application/json"
```

### Python 示例

```python
import requests

url = "http://127.0.0.1:8808/"

# 发送文本消息
data = {
    "token": "123123",
    "action": "sendtext",
    "to": ["线报转发", "LAVA"],
    "content": "你好，这是自动化测试消息"
}
response = requests.post(url, json=data)
print(response.json())

# 发送图片消息
data = {
    "token": "123123",
    "action": "sendpic",
    "to": ["线报转发", "LAVA"],
    "content": "https://example.com/image.jpg"
}
response = requests.post(url, json=data)
print(response.json())
```

### cURL 示例

```bash
# 发送文本消息
curl -X POST http://127.0.0.1:8808/ \
  -H "Content-Type: application/json" \
  -d '{"token":"123123","action":"sendtext","to":["线报转发"],"content":"测试消息"}'

# 发送图片消息
curl -X POST http://127.0.0.1:8808/ \
  -H "Content-Type: application/json" \
  -d '{"token":"123123","action":"sendpic","to":["线报转发"],"content":"https://example.com/image.jpg"}'
```

## 注意事项

### 使用前准备

1. **启动微信**：确保微信 PC 客户端已启动并登录
2. **微信窗口**：微信可以最小化，但不能关闭
3. **联系人名称**：确保联系人名称准确无误（区分大小写）

### 消息发送逻辑

1. 消息会立即加入队列并返回成功响应
2. 后台线程按顺序处理队列中的消息
3. 每条消息发送后会自动等待 1 秒（可在 config.json 中配置）
4. 如果某个联系人发送失败，会跳过该联系人继续处理下一条

### 日志查看

所有操作都会记录在日志文件中（默认：`wechat_automation.log`）：

```powershell
# 实时查看日志（PowerShell）
Get-Content wechat_automation.log -Wait

# 查看最后 50 行
Get-Content wechat_automation.log -Tail 50
```

### 常见问题

**Q: 提示"未找到微信窗口"**
- A: 确保微信已启动并且窗口标题为"微信"

**Q: 找不到联系人**
- A: 检查联系人名称是否正确，注意大小写

**Q: 消息发送失败**
- A: 查看日志文件了解详细错误信息

**Q: 如何修改 Token**
- A: 编辑 `config.json` 文件中的 `token` 字段

**Q: 如何修改消息间隔时间**
- A: 编辑 `config.json` 文件中的 `message_interval` 字段（单位：秒）

## 项目结构

```
winappdriver/
├── app.py                      # Flask 主服务
├── wechat_controller.py        # 微信控制器
├── message_queue.py            # 消息队列管理
├── config.json.example         # 配置文件示例
├── requirements.txt            # Python 依赖
├── disconnect_rdp.bat          # RDP 断开脚本
├── test/                       # 测试文件目录
│   ├── test_api.py            # API 测试脚本
│   └── README.md              # 测试说明
├── examples/                   # 示例代码目录
│   ├── wx.py                  # uiautomation 最小示例
│   └── README.md              # 示例说明
├── docs/                       # 文档目录
│   └── changelog.md           # 更新日志
├── README.md                   # 项目说明
├── 使用说明.md                 # 本文件
├── 快速启动指南.md             # 快速入门
├── .gitignore                  # Git 忽略文件
├── .cursorrules                # Cursor 规则文件
└── wechat_automation.log       # 日志文件（运行时生成）
```

## 技术栈

- **Flask**: Web 框架，提供 HTTP API
- **uiautomation**: Windows UI 自动化库
- **threading**: 多线程支持
- **queue**: 线程安全队列
- **logging**: 日志系统
- **requests**: HTTP 请求库，用于下载图片
- **Pillow**: 图片处理库
- **pywin32**: Windows API 支持，用于剪贴板操作

## 停止服务

按 `Ctrl+C` 停止服务，程序会优雅地关闭消息队列处理线程。

## 后续扩展

可以考虑添加的功能：

- [x] 支持发送图片（已完成）
- [ ] 支持发送文件
- [ ] 消息发送状态查询
- [ ] Web 管理界面
- [ ] 消息发送历史记录
- [ ] 支持群聊消息

